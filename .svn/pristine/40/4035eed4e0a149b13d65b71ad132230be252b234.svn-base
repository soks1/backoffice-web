/**
 * ==================================================================================
 * 공통 : 다이얼로그  TITLE 영역 CSS 변경
 * ==================================================================================
 */
$.widget("ui.dialog", $.extend({}, $.ui.dialog.prototype, {
	_title : function(title) {
		if (!this.options.title) {
			title.html("&#160;");
		} else {
			title.html(this.options.title);
		}
	}
}));


/**
 * ==================================================================================
 * 공통 : 리스트 화면 가기
 * ==================================================================================
 */
function f_mclubEventList() {
	var url = "/application/mclub/event/mclubEventLN.do";
	var method = "POST";
	cf_action(url, method, $("#frmKeepData").serialize());
}


/**
 * ==================================================================================
 * 공통 : 수정 화면 가기
 * ==================================================================================
 */
function f_mclubEventEdit() {
	var url = "/application/mclub/event/mclubEventEN.do";
	var method = "POST";
	cf_action(url, method, $("#frmKeepData").serialize());
}

/**
 * ==================================================================================
 * 공통 : 상세 화면 가기
 * ==================================================================================
 */
function f_mclubEventView() {
	var url = "/application/mclub/event/mclubEventRN.do";
	var method = "POST";
	cf_action(url, method, $("#frmKeepData").serialize());
}

/**
 * ==================================================================================
 * 리스트 화면 : 배너 삭제
 * ==================================================================================
 */
function f_mclubEventDelete() {
	
	if(confirm("해당 이벤트가 삭제되며 App에 즉시 반영됩니다. 삭제하시겠습니까?")) {
		var select_ids = [$("#frmKeepData").find("input[name=mclub_event_id]").val()];
		var data = {
			empno: $("#frmKeepData").find("input[name=empno]").val(), 
			emp_str_cd: $("#frmKeepData").find("input[name=emp_str_cd]").val(),
			mclub_event_id_list : select_ids
		};

		$.ajax({
			url: api_url + "/backoffice/mclub/event/delete",
			type: "POST",
			contentType: "application/json;charset=utf-8", // POST 일때만 사용
			async: false,
			cache: true,
			data: JSON.stringify(data),
			success: function(obj) {
				alert(obj.message);
				f_mclubEventList();
			},
			error: function(obj) {
		    	var serverObj = obj.responseJSON;
		    	alert("code:"+serverObj.code+"\n"+"message:"+cf_msg(serverObj.message)+"\n");
		    	return;
		    }
		});
		
	}
}

/**
 * ==================================================================================
 * 리스트 화면 : 쿠폰별 쿠폰북 정보 다이얼로그 호출
 * ==================================================================================
 */

function f_openmclubEventSD() {
	$.ajax({
		url: "/application/mclub/event/mclubEventSD.do",
		type: 'GET',
		async: true,
		cache: false,
		success: function(data) {
			var $target = $('#mclubevent_sd');
			$target.html(data);
		},
		complete: function() {
			$('#mclubevent_sd').dialog('open');
		}
	});
}

/**
 * ==================================================================================
 * 등록 화면 : 시간 설정
 * ==================================================================================
 */
function f_setTimeStr() {
	for(var h=0; h<24; h++) {
		var hour = h+"";
		if(hour.length < 2) {
			hour = "0" + hour;
		}
		
		$('#ntce_start_hour').append("<option value='"+hour+"'>"+hour+"</option>");
		$('#ntce_end_hour').append("<option value='"+hour+"'>"+hour+"</option>");
	
	}
	
	for(var m=0; m<60; m++) {
		var min = m+"";
		if(min.length < 2) {
			min = "0" + min;
		}
		
		$('#ntce_start_min').append("<option value='"+min+"'>"+min+"</option>");
		$('#ntce_end_min').append("<option value='"+min+"'>"+min+"</option>");
		
	}
}

/**
 * ==================================================================================
 * 리스트 화면 : 검색 이벤트
 * ==================================================================================
 */
function f_search() {
	
	// ------------------ 검색 벨리데이트 시작 ------------------ //
	
	if($("#frmSearch").searchValid() != true) {
		alert("검색 조건을 입력해 주세요.");
		return;
	}
	
	if( $('#ntce_start_dd').getObjLength() > 0 ) {
		if( $('#ntce_end_dd').getObjLength() < 1 ) {
			alert('종료일을 선택해 주세요');
			return;
		}
	}
	
	if( $('#ntce_end_dd').getObjLength() > 0 ) {
		if( $('#ntce_start_dd').getObjLength() < 1 ) {
			alert('시작일을 선택해 주세요');
			return;
		}
	}
	
	if( $('select[name=stype]').val() == '' && $('input[name=sword]').val() != '') {
		alert('키워드를 선택해 주세요');
		return;
	}
	
	// ------------------ 검색 벨리데이트 종료 ------------------ //
	
	// 초기화 버튼 추가
	f_addButton();
	
	// 검색 폼 데이터 추출
	var searchData = $("#frmSearch").serializeFormObject();
	
	// 검색 사용 중으로 변경
	$("#mclub_event_grid").jqGrid('setGridParam', {search: true});
	
	// 첫 페이지 셋팅
	$("#mclub_event_grid").jqGrid('setGridParam', {page: 1});
	
	// setGridParam을 이용해서 postData에 새로 설정해준 postData의 search에 설정 후 그리드를 다시 불러온다.
	$("#mclub_event_grid").jqGrid('setGridParam', {'postData' : {'search_info':searchData} }).trigger('reloadGrid');	
}

/**
 * ==================================================================================
 * 리스트 화면 : 검색 초기화 버튼 추가
 * ==================================================================================
 */
function f_addButton() {
	// 중복 취소 버튼 생성을 막기위한 기존 버튼 삭제
	$("#btn_cancel").remove();
	$("#btn_search").parent().append("<a href=\"javascript:void(0)\" id=\"btn_cancel\" onclick=\"f_cancel();\" class=\"btn btn-warning\"><i class=\"fa fa-remove\"></i> 초기화 </a>");
	
}

/**
 * ==================================================================================
 * 리스트 화면 : 검색 초기화 이벤트
 * ==================================================================================
 */
function f_cancel() {
	// 달력 minDate, maxDate 값을 초기화
	$( "#ntce_start_dd, #ntce_end_dd" ).datepicker( "option", {minDate: null, maxDate: null});
	// KeepData 폼 안에 input 태그 삭제
	$("#frmKeepData").empty();
	
	// 검색 초기화 버튼 삭제
	$("#btn_cancel").remove();
	
	// 검색 폼의 항목들 초기화
	$("#frmSearch").cleanObject();
	
	// 검색 폼 데이터 추출
	var searchData = $("#frmSearch").serializeFormObject();
	
	$("#mclub_event_grid").jqGrid('setGridParam', {search: false});
	$("#mclub_event_grid").jqGrid('setGridParam', {page: 1});
	// 검색 데이터 초기화 후 그리드 리로드
	$("#mclub_event_grid").jqGrid('setGridParam', {'postData' : {'search_info':searchData} }).trigger('reloadGrid');	
	
}

/**
 * ==================================================================================
 * 다이얼로그 화면 : 검색 이벤트
 * ==================================================================================
 */
function f_sdsearch() {
	//밸리데이션 체크
	if($('select[name=sd_mclub_id]').val() == ''){
		alert('M클럽을 선택해주세요.');
		return;
	}
	if($('select[name=sd_view_location]').val() == ''){
		alert('노출위치를 선택해주세요.');
		return;
	}
	
	// 검색 폼 데이터 추출
	var searchData = $("#frmCatSearch").serializeFormObject();
	searchData.mclub_id = $('select[name=sd_mclub_id]').val();
	searchData.view_location = $('select[name=sd_view_location]').val();
	
	// 검색 사용 중으로 변경
	$("#mclubevent_sort_grid").jqGrid('setGridParam', {search: true});
	
	// 첫 페이지 셋팅
	$("#mclubevent_sort_grid").jqGrid('setGridParam', {page: 1});
	
	// setGridParam을 이용해서 postData에 새로 설정해준 postData의 search에 설정 후 그리드를 다시 불러온다.
	$("#mclubevent_sort_grid").jqGrid('setGridParam', {'postData' : {'search_info':searchData} }).trigger('reloadGrid');
	
}


/**
 * ==================================================================================
 * 수정 화면 : 이미지 노출과 버튼 설정
 * ----------------------------------------------------------------------------------
 * 변수 : $('#preview_uploadfile1'), $("#uploadfile1"), obj.data.mclub_event_img_list[1], 'LIST'
 * 		  이미지, 버튼, 이미지 데이터[], 이미지파일구분코드
 * ==================================================================================
 */
function modifyImg(target1, target2, mclub_event_img_list, file_divn_cd){
	
	var preview = target1;
	
	preview.find('img').attr('src',mclub_event_img_list.prvw_url);
	
	var fName = '<p class="alert alert-info bd0">'+mclub_event_img_list.img_orgin_file_nm+'</p>';
	preview.parent().append(fName); 
	
	var span = $('<span>').addClass('btn_del_'+target2.attr("name"));
	var aTag = $('<a>')
				.addClass('btn btn-danger btn-sm')
				.attr('href','javascript:cf_fileDelete(\''+target2.attr("name")+'\')')
				.text('파일삭제');

	var input_file_divn_cd = $('<input>')
		.attr('type', 'hidden')
		.attr('name', 'file_divn_cd')
		.val(file_divn_cd);
	
	var input_local_file_name = $('<input>')
				.attr('type', 'hidden')
				.attr('name', 'img_strge_file_nm')
				.val(mclub_event_img_list.img_strge_file_nm);
	
	var input_atch_file_nm = $('<input>')
				.attr('type', 'hidden')
				.attr('name', 'img_orgin_file_nm')
				.val(mclub_event_img_list.img_orgin_file_nm);
	
	var img_file_divn_cd = $('<input>')
				.attr('type', 'hidden')
				.attr('name', 'img_file_divn_cd')
				.val(mclub_event_img_list.img_file_divn_cd);

	span.append(aTag);
	span.append(input_file_divn_cd);
	span.append(input_local_file_name);
	span.append(input_atch_file_nm);
	span.append(img_file_divn_cd);
	
	var btn_div = target2.parent().parent();
	btn_div.find("a").attr("disabled", true);
	btn_div.find("span").attr("disabled", true);
	btn_div.append(span);
	
}